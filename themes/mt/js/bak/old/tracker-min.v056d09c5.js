M.add("www-tracker",function(t){var e=t.mt.util,i=t.mt.lang,a="$",n="disable-tracking",r="acm",c="cks",o="mtt",s="abt",u=",";t.namespace("mt.www.tracker"),t.mt.www.tracker={init:function(t){this.applyConf(t),this.trackEvent(),this.trackQuery(),this.trackForm(),this.update()},applyConf:function(e){var i=this,a={cookie:"__t",delimiter:".",expire:{d:0,h:0,m:30},attr:"data-mttcode"};i.config=e?t.mix(e,a):a,i.EVENT_INI_PV=0,i.URL_INI_PV=1},update:function(){var e=this;if(!M.Env._isTCUptodate){M.Env._isTCUptodate=!0;var i=e.config.delimiter,a=e.getCookie();""!==a&&(a=a.split(i),a[1]=+a[1]+1,e.TS=t.Lang.now(),a[2]=e.TS,a=a.join(i),e.setCookie(a))}},setCookie:function(t){var i=this.config.cookie,a=this.config.expire,n=this.getExpires(a.d,a.h,a.m),r=/E\w+/,c=e.Cookie.get(i).match(r);c&&!t.match(r)&&(t+="."+c[0]),e.Cookie.set(i,t,n,"/","."+M.DOMAIN_HOST)},getCookie:function(){return e.Cookie.get(this.config.cookie)},initTrackingSession:function(e,i){var a=this,n=t.Lang.now(),r=[n,i,n,e].join(a.config.delimiter);a.TS=n,a.setCookie(r),M.Env._isTCUptodate=!0},getExpires:function(t,e,i){var a,n=this.TS;return"number"==typeof t&&"number"==typeof e&&"number"==typeof i?(a=new Date(n),a.setDate(a.getDate()+parseInt(t,10)),a.setHours(a.getHours()+parseInt(e,10)),a.setMinutes(a.getMinutes()+parseInt(i,10)),a.toUTCString()):""},_encode:function(e){var i=[];return t.Object.each(e,function(t,e){t!==a&&i.push(e+t)}),i.join(this.config.delimiter)},_decode:function(e){if(!e)return{};var i=e.split(this.config.delimiter),a={};return t.Array.each(i,function(t){a[t.charAt(0)]=t.slice(1)}),a},_parseUrl:function(t){var e,i="",a="";return e=t.indexOf("#"),e>-1&&(a=t.slice(e+1),t=t.slice(0,e)),e=t.indexOf("?"),e>-1&&(i=t.slice(e+1),t=t.slice(0,e)),{main:t,search:i,hash:a}},trackEvent:function(){var i=t.one(document.body),a=this,n="mttrigger",r="mtdisable",c=a.config.attr,o="mtnode",s="data-"+o;i.delegate("click",function(i){var u=i.target;if(("a"===u.get("tagName").toLowerCase()||u.hasClass(n)||u.ancestor("a, ."+n))&&!u.ancestor("."+r,!0)){var h,f=a._decode(this.getAttribute(c)),m=this.ancestors("["+s+"]"),l={};m.each(function(i){t.mix(l,a._decode(e.data(i,o)),!0)}),h=a._encode(t.mix(f,l)),a.initTrackingSession(h,a.EVENT_INI_PV)}},"["+c+"]")},_queryTrackingList:{acm:{urlKey:r,attrName:r,enableInherit:!0},mtt:{urlKey:o,enableInherit:!1},abt:{urlKey:s,attrName:s,enableInherit:!0,replaceRule:function(e,i){var a=[];return i&&(a=i.split(u)),e&&-1===t.Array.indexOf(a,e)&&a.push(e),a.join(u)}}},trackQuery:function(){var e=this;t.one(document.body).delegate("click",function(){var t=this.getAttribute("href");if(t&&0!==t.indexOf("javascript")&&0!==t.indexOf("#")&&-1!==this.get("hostname").indexOf(M.DOMAIN_HOST)&&!this.ancestor("."+n,!0)){var i;i=e.appendTrackingParams(t,{node:this}),i!==t&&this.setAttribute("href",i)}},"a")},trackForm:function(e){var i=this,a=e&&t.all(e)||t.all(".J-wwwtracker-form");a.each(function(t){var e,a,n=t.getAttribute("method")||"get";n=n.toLowerCase(),"get"===n?i.appendFormTrackingFields(t):"post"===n&&(e=t.getAttribute("action"),a=i.appendTrackingParams(e),a!==e&&t.setAttribute("action",a))})},disableQueryInherit:function(e){e=e||["acm","abt"];var i=this._queryTrackingList;t.Array.each(e,function(t){i[t]&&(i[t].enableInherit=!1)})},appendTrackingParams:function(a,n){n=n||{};var r,c=this._parseUrl(a),o=c.search,s=o&&i.parseStr(o,!1)||{};return o&&t.Object.each(this._queryTrackingList,function(t,e){s[t.urlKey]&&(n[e]=s[t.urlKey])}),r=this.getTrackingParams(n),t.Object.isEmpty(r)?a:(t.mix(s,r,!0),c.main+"?"+e.toPostData(s)+(c.hash?"#"+c.hash:""))},appendFormTrackingFields:function(e,a){a=a||{};var n,r=this.getTrackingParams(a);t.Object.each(r,function(t,a){n=e.one('[name="'+a+'"]'),n||e.appendChild('<input type="hidden" name="'+a+'" value="'+i.htmlEscape(t.toString())+'" />')})},_locationQuery:null,getTrackingParams:function(e){var a,n={},s=this,u=window.location.search,h=e.node;return e[o]=M.PAGE_VIEW_ID,a=this._locationQuery||(this._locationQuery=u&&i.parseStr(u?u.slice(1):"",!1)||{}),t.Object.each(this._queryTrackingList,function(t,i){var r,c=e[i],o=!1,u=a[t.urlKey];(c||h||u)&&(c?(r=c,o=!0):h&&t.attrName&&(r=s._getAncestorData(h,t.attrName)),(r||t.enableInherit)&&(r?!o&&t.replaceRule&&(r=t.replaceRule(r,u)):r=u,r&&(n[t.urlKey]=r)))}),n[r]&&(n[c]=this.getChecksum(n.acm)),n},_getAncestorData:function(t,i){var a=t.ancestor("[data-"+i+"]",!0);return a?e.data(a,i):""},_checksumDict:{},getChecksum:function(t){if(this._checksumDict[t])return this._checksumDict[t];var e,i,a,n,r;for(e=i=a=0;n=t.charCodeAt(a++);i=(i+e)%255)e=(e+n)%255;return r=i<<8|e,this._checksumDict[t]=r,r},trackUrl:function(e){function i(t){var e=t.mttcode,i=t.pathname,r=t.fnIsTargetUrl;a(i,r)&&n.initTrackingSession(e,n.URL_INI_PV)}function a(e,i){var a=window.location.pathname;return t.Lang.isArray(e)&&-1!==t.Array.indexOf(e,a)?!0:e&&a===e?!0:i&&i()?!0:!1}var n=this;n.applyConf(),t.Lang.isArray(e)?t.Array.each(e,i):i(e)}}},"1.0.0",{requires:["www-base"]});