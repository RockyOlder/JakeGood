M.add("mt-component",function(n){function t(n,e,o,a,i){this.node=n,this.name=e,this.config=o,this.params=a,this.callback=i,this.status=t.STATUS_INIT}var e=n.Lang.isString,o=n.Lang.isFunction,a=n.Array.each,i=n.Object.keys,s=n.mt.util,r=M.Groups[M.APP]?M.Groups[M.APP].modules:{},c={lazyRender:!0,priority:0,afterLoad:!0},u={transactions:[],retrieve:function(n){var t,e,o=this.transactions;for(t=0,e=o.length;e>t;++t)if(o[t].url===n)return o[t];return null},getCss:function(t,e){var o=this.retrieve(t);return o||(o={url:t,onfinish:[],load:!1,trans:n.Get.css(t,function(){o.load=!0,a(o.onfinish,function(n){n()}),window.setTimeout(function(){o.onfinish=null},0)})},this.transactions.push(o)),o.load?void e():void o.onfinish.push(e)}};n.mt.Component=t,t.CLASS_BOOTING="mt-component--booting",t.CLASS_BOOTED="mt-component--booted",t.STATUS_INIT=0,t.STATUS_CSS_LOADING=1,t.STATUS_RENDER=2,t.STATUS_JS_LOADING=3,t.STATUS_DONE=4,t.prototype={constructor:t,start:function(){var n=this,e=n.node,o=n.config;e.hasClass(t.CLASS_BOOTING)||e.hasClass(t.CLASS_BOOTED)||(e.addClass(t.CLASS_BOOTING),o.lazyRender||o.lazyDisplay?o.css?(n.status=t.STATUS_CSS_LOADING,u.getCss(o.css,function(){n.render(),n.invoke()})):(n.render(),n.invoke()):n.invoke())},render:function(){var n,e=this,o=e.node;e.status=t.STATUS_RENDER,e.config.lazyRender?(n=o.one('textarea[rel="lazyrender"]'),o.setHTML(n.get("value")),e._execScript()):o.show()},_execScript:function(){var n=this.node.all("script");n.each(function(n){if(!(n.get("src")||n.get("type")&&"text/javascript"!==n.get("type"))){var t=n.getHTML();t&&/\S/.test(t)&&window.eval.call(window,t)}})},invoke:function(){var e=this,o=e.callback;r[e.name]?(e.status=t.STATUS_JS_LOADING,n.use(e.name,function(){var a=n.mt.ComponentHub.invokeFns[e.name];e.status=t.STATUS_DONE,e.node.replaceClass(t.CLASS_BOOTING,t.CLASS_BOOTED),a&&a(e.node,e.params),o&&o(e.node,e.name)})):(e.status=t.STATUS_DONE,e.node.replaceClass(t.CLASS_BOOTING,t.CLASS_BOOTED),o&&o(e.node,e.name))}},n.mt.ComponentHub={invokeFns:{},attach:function(n,t){this.invokeFns[n]=t},boot:function(e,s){function r(n){a(c(n),function(t){var e=n[t];a(e,function(n){n.start()})})}function c(n){return i(n).sort(function(n,t){return t-n})}var u=n.mt.ComponentHub,S=(e||n).all("[data-component]"),d={},f={};S.each(function(e){var a,i=u.fetchData(e),r=i.config,c=r.priority,S="undefined"==typeof s||o(s)?s:s[i.name];e.getAttribute("id")||e.setAttribute("id",n.guid()),a=r.afterLoad?f:d,a[c]||(a[c]=[]),a[c].push(new t(e,i.name,r,i.params,S))}),r(d),M.loadQueue.push(function(){r(f)})},fetchData:function(t){var o=e(t)?n.one('[data-component="'+t+'"]'):t,a=s.decodeAttr;return o?{node:o,name:e(t)?t:s.data(o,"component"),config:n.merge(c,a(o,"component-config")),params:a(o,"component-params")}:null}}},"1.0.0",{requires:["mt-base","node"]});