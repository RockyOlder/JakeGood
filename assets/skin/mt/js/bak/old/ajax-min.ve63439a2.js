M.add("www-ajax",function(e){function t(){t.superclass.constructor.apply(this,arguments)}var n=e.io,a=e.mt.util,r=[],i=null,c=50,s=!1,o="start",u="complete",l="success",d="failure",f="end",m=[o,u,l,d,f],g="multiact",v="multiact-params",p="data-"+v,h="["+p+"]";e.namespace("mt.www"),t.NAME="multiact_transaction",t.ATTRS={action:{value:"",writeOnce:!0},args:{value:"",writeOnce:!0},config:{value:{},writeOnce:!0},label:{value:"",writeOnce:!0},id:{value:0,writeOnce:!0}},e.extend(t,e.Base,{initializer:function(){var t=this,n={emitFacade:!0,fireOnce:!0};t.request=null,e.Array.each(m,function(e){t.publish(e,n)}),t.listen(t.get("config"))},isInProgress:function(){return this.request?this.request.isInProgress():!0},listen:function(t){var n,a=this;return(n=t.on)?(t.mtData&&a._augmentEvents(n),e.Array.each(m,function(e){var r=n[e];"function"==typeof r&&(r=a.bind(r,e,t.mtData),a.on(e,r))}),a):void 0},_augmentEvents:function(t){if(t&&t[l]){var n=[];e.Object.each(b,function(e){n.push(e)}),t[f]&&(n=n.concat(t[f])),t[f]=function(){var t=arguments,a=this;e.Array.each(n,function(e){e.apply(a,t)})}}},bind:function(t,n,a){var r=this;return function(i){var c=r.request.id,s=e.merge(i._mtEnv,a);w.callWithErrorHandling(function(){n===o||n===f?t.call(r,c,s):t.call(r,c,s.response,s)})}},send:function(){return k.send(this)}});var b={_sendPerformance:function(e,t){var n=this,a=g+e,r=D.getMarks(a),i=r&&r._detail,c=i&&i[n.get("id")],s=t.performanceLabel;s&&c&&(c.jsEnd=D.now(),c.dataEnd=r.success,c.requestStart=r.start,c.requestDuration=r.success-r.start,c.jsBlocking=c.jsEnd-r.success,c.backend&&i[g].backend&&(c.backendDuration=i[g].backend,c.backendBlocking=c.backendDuration-c.backend,c.latency=c.requestDuration-c.backendDuration),w.sendPerformanceData(s,c))}},w={isOnline:function(){return M.Env["data-conf"]&&M.Env["data-conf"].online},callWithErrorHandling:function(e){if(!w.isOnline())return void e();try{e()}catch(t){}},isYUINodeInstance:function(e){return e&&!!e._node},sendPerformanceData:function(e,t){if(window.mta){var n={};n[e]=t,window.mta("timing","api",n)}},error:function(e){if(this._errorBooted)M._ERRORS.push(e);else{this._errorBooted=!0,M._ERRORS=[],M._ERRORS.push(e);var t=Date.now()%10;2>t&&!window.Raven&&M.createAsyncScript&&M.Env["data-conf"]&&M.Env["data-conf"].ravenUrl&&M.loadQueue.push(function(){M.createAsyncScript(M.Env["data-conf"].ravenUrl)})}}},D=function(){var e=window.performance,t=e&&e.now,n=function(){},a={};return t?{now:function(){return Math.round(e.now())},mark:function(e,t){a[e]||(a[e]={}),a[e][t]=this.now()},getMarks:function(e){return a[e]?a[e]:null},addDetail:function(e,t){a[e]||(a[e]={}),a[e]._detail=t}}:{mark:n,getMarks:n,addDetail:n}}(),k={_id:0,instanceLabelMap:{},instanceIdMap:{},create:function(n,a,r){if(w.isYUINodeInstance(n)&&(a=k.getConfig(n,a),n=a.uri,delete a.uri),!n)return null;var i,c=n.split("/"),s={};if(c.length>3?(s.action=c.splice(0,3).join("/"),s.args=c.join("/")):s.action=n,s.label=r||n,s.id=++this._id,a=a||{},s.config=a,a.mtData&&a.mtData.success){var o=a.mtData.success;a.on=a.on||{},a.on.success=function(t,n){if(!o.required||n[o.required]){var a=arguments,r=function(){e.use(o.mod,function(e){var t=e.namespace("mt."+o.ns),n=o.cb||"init";t[n]&&t[n].apply(t,a)})};o.afterLoad?M.loadQueue.push(r):r()}}}return i=new t(s),k.instanceLabelMap[s.label]?k.instanceLabelMap[s.label].unshift(i):k.instanceLabelMap[s.label]=[i],k.instanceIdMap[s.id]=i,i},getConfig:function(t,n){n=e.merge(n);var r=a.decodeAttr(t,v)||{},i=r.uri,c=r.mtData,s="post"===(r.method+"").toLowerCase()?"POST":"GET";return i?(delete r.uri,delete r.method,delete r.mtData,n.data=e.merge(r,n.data),n.method=s,n.uri=i,n.mtData=e.merge(n.mtData,c),n.mtData._node=t,n):n},getTransByLabel:function(e,t){return k.instanceLabelMap[e]?t?k.instanceLabelMap[e]:k.instanceLabelMap[e][0]:null},getTransById:function(e){return k.instanceIdMap[e]},send:function(t,a){var r,i={};return t=[].concat(t),a&&(i.label=a),i.postData=k.getBatchPostData(t),r=n("/multiact/default/"+(location.pathname||""),{method:"POST",data:i.postData,on:k.getBatchCallbacks(t),arguments:i}),e.Array.each(t,function(e){e.request=r}),i.request},getBatchPostData:function(t){var n={};return e.Array.each(t,function(t){var a,r={},i=t.get("config"),c=i.data;c&&(i.method&&"post"===i.method.toLowerCase()?r.post=c:r=e.merge(c)),r.act=t.get("action"),a=t.get("args"),a&&(r.args=a),n[t.get("id")]=e.JSON.stringify(r)}),n},getBatchCallbacks:function(t){function n(e,t,n){t=t||500;var a=t+":\n";a+="multiact:\n",e&&(a+=e+":\n"),n&&(a+=n+":\n"),w.error(a)}function r(r,i,c){e.Array.each(t,function(t){var s=e.merge(i),o=t.get("id");return c&&c[o]&&(s.response=a.decodeJSON(c[o]),r===l&&404===s.response.status)?void n(t.get("label"),404,"single request 404"):void t.fire(r,{_mtEnv:s})})}function i(t,n,a){var r,i=g+t,c=D.getMarks(i);n&&n[g]&&c&&(D.addDetail(i,n),r=e.merge(n[g]),r.requestStart=c.start,r.requestDuration=c.success-c.start,r.dataEnd=c.success,r.backend&&(r.latency=r.requestDuration-r.backend),e.Object.each(n,function(e,t){var n;t!==g&&(n=k.getTransById(t),n&&e.backend&&(r["backend."+n.get("action").replace(/\//g,"_")]=e.backend))}),w.sendPerformanceData(a,r))}return{start:function(e,t){D.mark(g+e,"start"),r(o,t)},complete:function(e,t,n){var i=a.getEvalRes(t);r(u,n,i)},success:function(e,t,n){var c=a.getEvalRes(t);D.mark(g+e,"success"),n.label&&i(e,c.performance,n.label),r(l,n,c)},failure:function(t,i,c){var s=a.getEvalRes(i),o="";e.Object.each(c.postData,function(e,t){var n=k.getTransById(t);n&&(o+=", "+n.get("label"))}),n(c.label,i.status,i.constructor.name+":"+o+"\n"+i.responseText.slice(0,100)),r(d,c,s)},end:function(e,t){r(f,t)}}}};e.mt.www.Ajax={init:function(t){var n=e.mt.www.Ajax;t=e.one(t||"body"),t&&(n._add(t),t.all(h).each(function(e){n._add(e)}),n.send(null,"multiact-init"))},_add:function(t,n,a,s){var o,u=e.mt.www.Ajax;return o=k.create(t,n,a),o&&(r.push(o),s&&(i&&window.clearTimeout(i),i=window.setTimeout(function(){u.send()},c))),o},io:function(t,n,a){var r,i,c=e.mt.www.Ajax;return w.isYUINodeInstance(t)&&(n=k.getConfig(t,n),t=n.uri,delete n.uri),t?(r=n.mtData||{},a=a||t,r.useCache&&(i=k.getTransByLabel(a))?i.listen(n):r.useBuffer&&s?c._add(t,n,a,!0):(i=k.create(t,n,a),i.send())):null},openBuffer:function(){s=!0},closeBuffer:function(){s=!1},send:function(e,t){return e||(e=r,r=[]),i&&(window.clearTimeout(i),i=null),e.length?k.send(e,t):void 0}}},"1.0.0",{requires:["mt-base","base-base","io-base","io-form"]});