M.add("search-box",function(e){function t(){this.initEntries()}function i(e){this.action=e,this.originKeyword="",this.async=null,this.timer=null,this.cache={},this.showHistory=!0}function s(e){this.ndContainer=e,this.ndPanel=e.next("."+s.CLASS_SMART_QUERY_PANEL),this.list=[],this.status=s.STATUS_NULL,this.originKeyword="",this.suggestChangeCounter=0,this.acmViewTimer=null,this.preventSubmission=!1}var n=e.io,r=e.Lang.trim,a=e.mt.util,o=a.Cookie,h=e.mt.macro,c=e.mt.www.tracker,l=e.mt.plugin.Placeholder,_=!1;t.SUPPORT_LOCALSTORAGE=window.localStorage?!0:!1,t.SEARCH_HISTORY_MAX_LIMIT=t.SUPPORT_LOCALSTORAGE?10:5,t.SEARCH_HISTORY_COOKIE_NAME="sh",t.prototype={constructor:t,initEntries:function(){var i;i=t.SUPPORT_LOCALSTORAGE?localStorage.getItem(t.SEARCH_HISTORY_COOKIE_NAME):o.get(t.SEARCH_HISTORY_COOKIE_NAME),this.entries=i?e.JSON.parse(i):[]},add:function(i,s){if(""!==i){var n,r=this,a=r.entries,o=s.toLowerCase(),h=-1;n=e.some(a,function(e,t){for(var i=e[1].length;i--;)if(e[1][i].toLowerCase()===o)return e[1].splice(i,1),e[1].push(s),a.splice(t,1),a.push(e),r.update(),!0}),n||(e.some(a,function(e,t){return e[0]===i?(h=t,!0):void 0}),h>-1?a[h][1].push(s):a.push([i,[s]]),r.getLength()>t.SEARCH_HISTORY_MAX_LIMIT&&r.shift(),r.update())}},remove:function(t){var i,s,n,r=this,a=r.entries,o=a.length;if(0!==o){for(n=0;o>n;++n)i=a[n],s=e.Array.indexOf(i[1],t),-1!==s&&(i[1].splice(s,1),0===i[1].length&&(a.splice(n--,1),o--));r.update(),r.fire("remove",t)}},search:function(t){var i=[],s=t?3:10;return e.each(this.entries,function(e){var s=e[0].toLowerCase(),n=t.toLowerCase();if(0===s.indexOf(n))i=i.concat(e[1]);else for(var r=e[1].length;r--;)0===e[1][r].indexOf(n)&&i.push(e[1][r])}),i=i.splice(0,s)},update:function(){t.SUPPORT_LOCALSTORAGE?localStorage.setItem(t.SEARCH_HISTORY_COOKIE_NAME,e.JSON.stringify(this.entries)):o.set(t.SEARCH_HISTORY_COOKIE_NAME,e.JSON.stringify(this.entries),o.getExpiresDate(30,0,0),"/","."+M.DOMAIN_HOST)},shift:function(){var e=this.entries;1===e[0][1].length?e.shift():e[0][1].shift()},getLength:function(){for(var e=this.entries,t=0,i=e.length;i--;)t+=e[i][1].length;return t}},e.augment(t,e.EventTarget),i.DELAY=500,i.prototype={fetch:function(t,s){var n=this,r=n.cache[t];return e.Lang.isArray(r)?(n.setShowHistoryStatus(r.concat(),n),void s(r.concat())):void(n.timer||(n.timer=window.setTimeout(function(){n.request(s),n.timer=null},i.DELAY)))},request:function(e){var t,i=this,s=i.originKeyword.replace(/'/g,""),r=i.async;return s?(r&&r.isInProgress()&&r.abort(),t=c.appendTrackingParams(i.action+s),void(r=n(t,{method:"POST",on:{success:function(t,n){var r=a.getEvalRes(n);i.setShowHistoryStatus(r,i),i.updateCache(s,r),e(r)}}}))):void e([])},setShowHistoryStatus:function(e,t){var i=e.length;for(t.showHistory=!0;i--;)if("movie"===e[i].category_type&&3!==e[i].show_info_type)return void(t.showHistory=!1)},updateCache:function(t,i){this.cache[t]=e.Lang.isArray(i)&&i.length>0?i.concat():null}},s.MAX_SUGGEST_COUNT=10,s.STATUS_NULL=0,s.STATUS_SHOW=1,s.STATUS_HIDDEN=2,s.STATUS_SELECTED=3,s.DELAY=200,s.CLASS_ITEM="search-suggest__item",s.CLASS_ITEM_MOVIE="search-suggest__item--movie",s.CLASS_ITEM_BORDER="search-suggest__item--border",s.CLASS_HOVER="search-suggest__item--over",s.CLASS_HISTORY="search-suggest__item--history",s.CLASS_ITEM_COUNT="search-suggest__item--count",s.CLASS_SMART_QUERY_HTML="smart-query-html",s.CLASS_SMART_QUERY_PANEL="smart-query-panel",s.CLASS_SMART_QUERY="smart-query-content",s.CLASS_SMART_QUERY_ITEM="smart-query__item",s.CLASS_SMART_QUERY_ITEM_MOVIE="smart-query__item--movie",s.CLASS_SMART_QUERY_ITEM_MOVIE_HOOK="smart-query__item--movie__hook",s.CLASS_SMART_QUERY_ITEM_MOVIE_INFO="smart-query__item--movie__info",s.SEARCH_HISTORY_TPL='<li class="'+s.CLASS_ITEM+' {tipClass}"><a href="javascript:void(0)" class="remove" data-tip="{tipContent}">删除</a>{tipContent}</li>',s.ACM_VIEW_SEND_THRESHOLD=200,s.prototype={constructor:s,render:function(){function t(e){var t="";switch(e.category_type){case"cld":t=i(e);break;case"movie":S=!1,t=n(e);break;case null:t=i(e)}return t}function i(t){var i="";return t.sec_rec.length&&(i+='<div class="'+s.CLASS_SMART_QUERY_HTML+'" style="display:none">   <h5>'+t.word+'</h5>   <div class="smart-query-wrapper">       <ul class="smart-query">',e.each(t.sec_rec,function(e){i+='<li class="'+s.CLASS_SMART_QUERY_ITEM+'">'+e.word+"</li>"}),i+="       </ul>   </div></div>"),i}function n(e){var t="";switch(e.show_info_type){case 1:var i=0,n=e.sec_rec.length;if(n){for(t+='<div class="'+s.CLASS_SMART_QUERY_HTML+'" style="display:none">   <div class="smart-query-wrapper">       <ul class="smart-query">';n>i;){var r=e.sec_rec[i],a=r.movie_show_info.url,o=r.movie_show_info.score.split("."),h="";a=c.appendTrackingParams(a,{code:r.macm}),0===i&&(h=" collapse-item--first collapse-item--active"),t+='<li class="'+s.CLASS_SMART_QUERY_ITEM_MOVIE+h+' collapse-item">   <h5 class="collapse__trigger f2-b">       <span class="info-index info-index-'+(i+1)+'"></span>'+r.word+'<i class="tri tri--down"></i>   </h5>   <div class="collapse__content cf">       <a href="'+a+'" class="info-img '+s.CLASS_SMART_QUERY_ITEM_MOVIE_HOOK+" "+s.CLASS_SMART_QUERY_ITEM_MOVIE_INFO+'">           <img class="img-border" src="'+r.movie_show_info.imgurl+'" width="60" height="85" />       </a>       <div class="info-content">           <p class="score">               <strong class="rates">'+o[0]+'<strong class="rates-point">.'+o[1]+'</strong>               </strong>           </p>           <p class="desc">'+r.movie_show_info.description+'</p>           <p class="purchase">              <a class="btn btn-small '+s.CLASS_SMART_QUERY_ITEM_MOVIE_HOOK+" "+s.CLASS_SMART_QUERY_ITEM_MOVIE_INFO+'" href="'+a+'">购买</a>          </p>       </div>   </div></li>',i++}t+="       </ul>   </div></div>"}break;case 2:if(e.sec_rec.length){var l=e.sec_rec[0],_=l.movie_show_info.url;_=c.appendTrackingParams(_,{code:l.macm}),t+='<div class="'+s.CLASS_SMART_QUERY_HTML+'" style="display:none">   <div class="smart-query-wrapper">       <ul class="smart-query">           <li class="'+s.CLASS_SMART_QUERY_ITEM_MOVIE+' movie--online">               <div class="movie--info cf">                   <a href="'+_+'" class="info-img '+s.CLASS_SMART_QUERY_ITEM_MOVIE_HOOK+" "+s.CLASS_SMART_QUERY_ITEM_MOVIE_INFO+'">                       <img class="img-border" src="'+l.movie_show_info.imgurl+'" width="60" height="85" />                   </a>                   <div class="info-content">                       <h5 class="f2-b">'+l.word+'                       </h5>                        <p class="score--stars">                           <span class="common-rating">                               <span class="rate-stars" style="width:'+10*l.movie_show_info.score+'%;"></span>                           </span>                       </p>                       <p class="purchase">                          <a class="btn btn-small '+s.CLASS_SMART_QUERY_ITEM_MOVIE_HOOK+" "+s.CLASS_SMART_QUERY_ITEM_MOVIE_INFO+'" href="'+_+'">购买</a>                      </p>                   </div>               </div>               </li>           <p class="color-weaken theatre-rec">为您推荐</p>';for(var u=0;6>u;u++){var S=l.movie_show_info.theatre[u],d=c.appendTrackingParams(S.url,{code:l.macm});t+='<p class="theatre-list"><a href="'+d+'">'+S.name+"</a></p>"}var g=c.appendTrackingParams("/dianying/all",{code:l.macm});t+='           <p class="theatre-more"><a href="'+g+'" class="color-text">更多影院></a></p>       </ul>   </div></div>'}}return t}function r(e){u=!1,l=!1,S=!0,"movie"===e.category_type&&(S=!1,1===e.show_info_type?u=!0:2===e.show_info_type&&(l=!0))}for(var a="",o=e.mt.lang.htmlEscape,h=this,l=!1,u=!1,S=!0,d=0,g=0,m=h.list.length;m>g;g++){var f=h.list[g],p=h.list[g+1],T="",y="",E="",A="",v="";switch(r(f),f.type){case"tip":T='<li class="search-suggest__tip">'+f.tip+"</li>";break;case"history":T=e.Lang.sub(s.SEARCH_HISTORY_TPL,{tipClass:s.CLASS_HISTORY,tipContent:o(f.word)});break;case"suggestion":E=t(f),!_&&f.count>=0&&S&&(y='<span class="'+s.CLASS_ITEM_COUNT+'">约'+f.count+"个团购</span>"),E?(A='<span class="search-suggest__keyword">',l&&(A+='<span class="info-index info-index-'+ ++d+'"></span>'),A+=f.word,u&&(A+='<span class="hot"></span>'),A+="</span>"):A=f.word,"movie"===f.category_type&&2===f.show_info_type&&(v=" "+s.CLASS_ITEM_MOVIE,("movie"!==p.category_type||2!==p.show_info_type)&&(v+=" "+s.CLASS_ITEM_BORDER)),T='<li class="'+s.CLASS_ITEM+v+' cf">'+y+E+A+"</li>"}a+=T}this.ndContainer.setHTML(a)},bind:function(){function t(){return r()?(S=!0,void window.setTimeout(function(){t()},s.DELAY)):(S=!1,d&&window.clearTimeout(d),void(a()||(h.dehighlight(),_&&h.highlight(_))))}function i(){u||(u=e.one(document).on("mousemove",function(e){g.x=m.x,g.y=m.y,m.x=e.pageX,m.y=e.pageY}))}function n(){u&&(u.detach(),u=null)}function r(){var e,t,i={x:o[0],y:o[1]},s={x:o[0],y:o[1]+o.height};return e=(i.x-g.x)*(m.y-g.y)-(i.y-g.y)*(m.x-g.x),t=(s.x-g.x)*(m.y-g.y)-(s.y-g.y)*(m.x-g.x),e>0&&0>t&&m.x<i.x}function a(){return m.x>=o[0]&&m.x<=o[0]+o.width&&m.y>=o[1]&&m.y<=o[1]+o.height}var o,h=this,c=h.ndContainer,l=h.ndPanel,_=null,u=null,S=!1,d=null,g={},m={};c.on("hover",i,n),l.on("hover",i,n),c.delegate("hover",function(){_=this,S||h.highlight(this)},function(){_=null,"none"===l.getStyle("display")||S||(o=l.get("region"),t())},"."+s.CLASS_ITEM),c.delegate("click",function(e){e.halt(!0),h.remove(this.ancestor("."+s.CLASS_ITEM))},".remove"),c.delegate("click",function(){var e=h.indexOf(this),t=h.list[e];h.fire("select",t)},"."+s.CLASS_ITEM),l.delegate("click",function(e){e.halt();var t=h.getHighlightedIndex(),i=l.all("."+s.CLASS_SMART_QUERY_ITEM).indexOf(this),n=h.list[t].sec_rec[i];n.type="smartquery",h.fire("selectSmartQuery",n)},"."+s.CLASS_SMART_QUERY_ITEM),l.delegate("click",function(){var e=h.getHighlightedIndex(),t=Math.floor(l.all("."+s.CLASS_SMART_QUERY_ITEM_MOVIE_HOOK).indexOf(this)/2),i=h.list[e].sec_rec[t];h.preventSubmission=!0,i.type="smartquery",h.fire("selectSmartQuery",i)},"."+s.CLASS_SMART_QUERY_ITEM_MOVIE_HOOK)},show:function(e){(this.status===s.STATUS_SHOW||this.status===s.STATUS_SELECTED)&&this.hide(),this.status=s.STATUS_SHOW,this.list=e.slice(0,s.MAX_SUGGEST_COUNT),this.render(),this.ndContainer.getHTML()&&this.ndContainer.setStyle("height","auto").show(),this.suggestChangeCounter++;var t=this,i=t.suggestChangeCounter;t.acmViewTimer&&clearTimeout(t.acmViewTimer),t.acmViewTimer=setTimeout(function(){i===t.suggestChangeCounter&&t._sendSmartBoxView(t.list)},s.ACM_VIEW_SEND_THRESHOLD)},hide:function(){this.status=s.STATUS_HIDE,this.ndContainer.hide(),this.ndPanel.hide(),this.suggestChangeCounter++},remove:function(e){var t,i,s=this;t=s.indexOf(e),e.remove(),i=s.list[t],s.list.splice(t,1),s.fire("remove",i)},destroy:function(){this.status=s.STATUS_NULL,this.ndContainer.hide().setHTML(""),this.ndPanel.hide(),this.list=[]},size:function(){return this.list.length},indexOf:function(e){return this.ndContainer.all("> li").indexOf(e)},highlight:function(e){var t,i,n,r="has-hovered";this.dehighlight(),this.status=s.STATUS_SELECTED,e.hasClass(s.CLASS_ITEM)?(e.addClass(s.CLASS_HOVER),t=this.indexOf(e),n=this.list[t],i="movie"===n.category_type?!0:!1,n.sec_rec&&n.sec_rec.length?(this.showSmartQuery(e,i),e.getData(r)||(this._sendSmartBoxView(n.sec_rec),e.setData(r,!0))):this.hideSmartQuery(),this.fire("highlight",n)):this.hideSmartQuery()},dehighlight:function(){this.status===s.STATUS_SELECTED&&(this.ndContainer.all("."+s.CLASS_ITEM).removeClass(s.CLASS_HOVER),this.hideSmartQuery(),this.status=s.STATUS_SHOW)},highlightVertical:function(t){var i,n,r,a=this,o=a.status,h=a.ndContainer.all("> li"),c=a.list,l=[];e.each(a.list,function(e,t){("suggestion"===e.type||"history"===e.type)&&l.push(t)}),i=l.length,o===s.STATUS_HIDDEN&&a.show(),o===s.STATUS_SHOW?(n=l["up"===t?i-1:0],this.highlight(h.item(n)),r=c[n]):(n=this.getHighlightedIndex(),"up"===t?n===l[0]?(this.dehighlight(),r={type:"origin",word:this.originKeyword}):(n=l[e.Array.indexOf(l,n)-1],this.highlight(h.item(n)),r=c[n]):n===l[i-1]?(this.dehighlight(),r={type:"origin",word:this.originKeyword}):(n=l[e.Array.indexOf(l,n)+1],this.highlight(h.item(n)),r=c[n])),this.fire("updateKeyword",r)},getHighlightedIndex:function(){if(this.status!==s.STATUS_SELECTED)return-1;var e=this.ndContainer.one("."+s.CLASS_HOVER);return e?this.indexOf(e):-1},showSmartQuery:function(e,t){var i,n,r,a,o,h,c=e.one("."+s.CLASS_SMART_QUERY_HTML),l=this.ndContainer,_=this.ndPanel,u=_.one("."+s.CLASS_SMART_QUERY);u.setStyle("marginTop",0).setHTML(c.getHTML()),n=e.get("region"),i=l.get("region"),_.setStyles({visibility:"hidden",display:"",height:"auto"}).removeAttribute("hidden"),r=_.get("region"),r.height>i.height?(l.setStyle("height",r.height),_.setStyle("height",r.height),i=l.get("region")):(_.setStyle("height",i.height-1),r=_.get("region")),_.setStyle("visibility","visible"),a=u.get("region"),o=r.height-a.height,h=n[1]-r[1],t?u.setStyle("marginTop",0):u.setStyle("marginTop",Math.max(Math.min(o,h),0))},hideSmartQuery:function(){this.ndPanel.hide()},_sendSmartBoxView:function(t){var i=[];e.Array.each(t,function(e){e.acm&&e.macm&&i.push(e)}),i.length&&(window._mbq("sendReclsView",i,"word","acm"),window._mbq("trackModuleview",{pm:"sm"}))}},e.augment(s,e.EventTarget),e.mt.www.SmartBox={init:function(n){function o(){E.on("submit",function(e){e.halt();var t=u();t?(d(),S(t)):_&&(location.href="/shops/")}),L.on({valuechange:f,click:f,blur:function(){O=window.setTimeout(function(){w.hide()},Q)},keydown:T}),A.on("remove",function(){L.focus()}),w.bind(),w.on("remove",function(e){O&&(window.clearTimeout(O),O=null),A.remove(e.word)}),w.on("select",function(e){d(e.type),S(e.word,e.acm,e.macm)}),w.on("selectSmartQuery",function(e){d(e.type),S(e.word,e.acm,e.macm)}),w.on("updateKeyword",function(e){d(e.type),L.set("value",e.word)}),k&&(I.on("hover",function(){this.addClass(V)},function(){this.removeClass(V)}),I.delegate("click",function(){if(!this.hasClass(N)){var e=this.hasClass("J-search-box__tab--deal")?"deal":"shop";m(e),I.removeClass(V)}},".search-box__tab"))}function u(){return r(L.get("value")).replace(/\s{2,}/g," ")}function S(e,t,i){var s={};A.add(u(),e),L.set("value",e),i&&(s={acm:i}),c.appendFormTrackingFields(E,s),w.preventSubmission||window.setTimeout(function(){E.submit()},Q),g(e,t),c.config||c.applyConf(),c.initTrackingSession(C,c.EVENT_INI_PV)}function d(e){var t=_?"poi":"";switch(e){case"history":C="A"+t+"search.Bhistory";break;case"suggestion":C="A"+t+"search.Bsmartbox";break;case"smartquery":C="A"+t+"search.Bsmartquery";break;default:C="A"+t+"search.Bmaintop"}}function g(e,t){t&&(window._mbq("sendReclsClick",e,t),window._mbq("localEventlog","UserAction","Click","module/click",{pm:"sm"}))}function m(t){var i=L.get("value"),s=e.one("#J-deal-hot-query"),n=e.one("#J-poi-hot-query"),r=L.getAttribute("placeholder");return""!==i&&i!==r?void(location.href=("deal"===t?"/s/?w=":"/shops/?w=")+i):(b.removeClass(N),"deal"===t?(_=!1,H.addClass(N).insert(x,"after"),L.setAttribute("placeholder","请输入商品名称、地址等"),E.setAttribute("action","/s/"),s&&s.show(),n&&n.hide()):(_=!0,x.addClass(N).insert(H,"after"),L.setAttribute("placeholder","请输入商家名称、地址等"),E.setAttribute("action","/shops/"),s&&s.hide(),n&&n.show()),L.unplug(l),void L.plug(l))}function f(){if(!Y){var e=u();v.originKeyword=e,w.originKeyword=e,v.fetch(e,function(e){e?p(e):w.destroy()})}}function p(t){var i=u(),s=A.search(i),n=[],r=0;if(""===i&&(v.showHistory=!0),v.showHistory&&s.length){n.push({type:"tip",tip:"最近搜过"});for(var a=s.length;a--;){for(var o=s[a],h="AsearchBs_query_history",c=t.length;c--;)if(o===t[c].word){h=t[c].acm;break}n.push({type:"history",word:o,acm:h})}}e.each(t,function(t){if(-1===e.Array.indexOf(s,t.word)){if("movie"===t.category_type&&2===t.show_info_type){if(r>2)return;r++}if(t.type="suggestion","movie"===t.category_type&&4===t.show_info_type){var i='<a href="dianying/all" class="color-weaken" onclick="_mbq(\'sendReclsClick\', \''+t.word+"', '"+t.acm+"');\">"+t.word+"</a>";t.type="tip",t.tip=i}n.push(t)}}),w.show(n),L.focus()}function T(e){var t;if(w.status!==s.STATUS_NULL)switch(e.keyCode){case h.key.ESC:L.blur();break;case h.key.UP:Y=!0,w.highlightVertical("up");break;case h.key.DOWN:Y=!0,w.highlightVertical("down");break;case h.key.ENTER:Y=!0,e.halt(),t=w.getHighlightedIndex(),t>-1?S(u(),w.list[t].acm,w.list[t].macm):S(u());break;default:Y=!1}}var y=e.one(n)||e.one(".site-mast"),E=y.one(".J-search-form");if(E){var A,v,w,C,M,O,L=a.field(E,"w"),R=y.one(".J-search-suggest"),I=y.one(".search-box__tabs-container"),b=y.all(".search-box__tab"),H=y.one(".J-search-box__tab--deal"),x=y.one(".J-search-box__tab--shops"),U=L.getData("smartbox"),k=b.size()>0,Y=!1,Q=200,V="search-box__tabs-container--over",N="search-box__tab--current";_="/shops/"===E.getAttribute("action"),A=new t,v=new i(U),w=new s(R),M=u(),v.originKeyword=M,w.originKeyword=M,L.plug(l),d(),o()}}},e.mt.ComponentHub.attach("search-box",function(){e.mt.www.SmartBox.init()})},"1.0.0",{requires:["www-base","www-tracker"]});